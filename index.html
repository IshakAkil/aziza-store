<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZIZIA STORE Assistant</title>
    
    <!-- External Libraries: Icons (Phosphor) and PDF Generator (jsPDF) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-color: #ffffff;
            --text-color: #1c1e21;
            --primary-color: #007aff;
            --secondary-color: #e9e9eb;
            --border-color: #dcdfe3;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545;
            --ai-color: #8e44ad;
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* --- Basic Setup --- */
        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevents whole page from scrolling */
        }
        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
        }

        #app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        
        /* --- Top Bar --- */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 340px; /* Adjust for cart width */
            height: 60px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }
        .top-bar h1 {
            font-size: 24px;
            margin: 0;
        }
        .top-bar-icons button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 24px;
            color: var(--text-color);
            margin-left: 15px;
            transition: color 0.2s ease;
        }
        .top-bar-icons button:hover { color: var(--primary-color); }
        .top-bar-icons button.ai-feature:hover { color: var(--ai-color); }


        /* --- Main Product Grid --- */
        #product-grid {
            flex-grow: 1;
            padding: 80px 20px 20px; /* Space for top bar */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            overflow-y: auto;
            height: 100vh;
        }
        .product-card {
            position: relative;
            cursor: pointer;
            aspect-ratio: 1 / 1;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            background-color: var(--secondary-color);
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px var(--shadow-color);
        }
        .product-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .product-tooltip {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }
        .product-card:hover .product-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        .placeholder {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            color: #888;
        }

        /* NEW: Out of Stock Indicator */
        .product-card.out-of-stock {
            opacity: 0.7; /* Slightly dim it */
            pointer-events: none; /* Make it unclickable */
        }
        .product-card.out-of-stock::after {
            content: "Out of Stock";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(220, 53, 69, 0.6); /* Red shade */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: var(--border-radius);
            z-index: 5; /* Above image, below tooltip */
        }
        .product-card.out-of-stock:hover .product-tooltip {
            display: none; /* Hide tooltip for out of stock */
        }


        /* --- Cart Panel --- */
        #cart-panel {
            width: 340px;
            flex-shrink: 0;
            height: 100vh;
            background-color: var(--panel-color);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px var(--shadow-color);
        }
        .cart-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .cart-header h2 { font-size: 20px; margin: 0; }
        #cart-total { font-weight: 600; font-size: 18px; }

        #cart-items {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .cart-placeholder {
            padding: 20px;
            text-align: center;
            color: #aaa;
            font-style: italic;
        }

        .cart-item {
            position: relative;
            display: flex;
            align-items: center;
            /* CHANGED: Adjusted padding to make space for the button on the left */
            padding: 10px 10px 10px 40px;
            margin-bottom: 10px;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
        }
        .cart-item-delete-btn {
            position: absolute;
            /* CHANGED: Moved to the left and vertically centered */
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            background-color: var(--secondary-color);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            font-size: 12px;
            transition: background-color 0.2s, color 0.2s;
        }
        .cart-item-delete-btn:hover {
            background-color: var(--danger-color);
            color: white;
        }

        .cart-item-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 10px;
            background-color: #fff;
        }
        .cart-item-details {
            flex-grow: 1;
        }
        .cart-item-name { font-weight: 600; }
        .cart-item-price { font-size: 14px; color: #555; }
        /* NEW: Style for individual item total */
        .cart-item-total {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 5px; /* Space below price */
        }
        .cart-item-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }
        .price-tier-selector {
            display: flex;
            gap: 4px;
        }
        .price-tier-selector button {
            border: 1px solid var(--border-color);
            background-color: #fff;
            border-radius: 6px;
            padding: 3px 6px;
            font-size: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        .price-tier-selector button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .quantity-controls {
            display: flex;
            align-items: center;
        }
        .quantity-controls button {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            background-color: white;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            line-height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.1s;
        }
        .quantity-controls button:active { background-color: var(--secondary-color); }
        .quantity-value { font-size: 16px; font-weight: 500; padding: 0 10px; }
        .unit-selector { font-size: 12px; cursor: pointer; color: var(--primary-color); margin-left: 5px; font-weight: 500;}

        .cart-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .checkout-button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .checkout-button:hover:not(:disabled) { background-color: #0056b3; }
        .checkout-button:disabled { background-color: #aaa; cursor: not-allowed;}

        /* --- Modal --- */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #modal-content {
            background: var(--panel-color);
            border-radius: var(--border-radius);
            padding: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        #modal-overlay.visible #modal-content {
            transform: scale(1);
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--secondary-color);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            border: 4px solid var(--secondary-color);
            border-top: 4px solid var(--ai-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* --- Form & AI Styles --- */
        .form-section h3 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 20px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: var(--font-family);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .price-tier-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .settings-actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;}
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); }
        .btn-ai { background-color: var(--ai-color); color: white; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        #product-list-settings ul { list-style: none; padding: 0; }
        #product-list-settings li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        #product-list-settings li:last-child { border-bottom: none; }

        .sales-log-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .sales-log-table { width: 100%; border-collapse: collapse; }
        .sales-log-table th, .sales-log-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .sales-log-table th { font-weight: 600; }
        
        .ai-result-box {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .notification-bar {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            transition: bottom 0.5s ease-in-out;
            font-size: 14px;
        }
        .notification-bar.show {
            bottom: 20px;
        }


        /* --- Responsive Design --- */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow: auto; }
            #app-container {
                flex-direction: column;
                height: auto;
            }
            #cart-panel {
                position: relative;
                width: 100%;
                height: auto;
                max-height: 45vh; /* Limit cart height on mobile */
                border-left: none;
                border-top: 2px solid var(--border-color);
            }
            .top-bar {
                right: 0; /* Full width */
            }
            #product-grid {
                height: auto; /* Allow grid to determine its height */
                min-height: 50vh;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                padding-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- TOP BAR WITH ICONS -->
        <header class="top-bar">
            <h1>AZIZIA STORE</h1>
            <div class="top-bar-icons">
                <button id="sales-log-btn" title="Sales Log"><i class="ph-bold ph-list-dashes"></i></button>
                <button id="settings-btn" title="Settings & AI Tools"><i class="ph-bold ph-gear"></i></button>
            </div>
        </header>

        <!-- MAIN PRODUCT DISPLAY -->
        <main id="product-grid">
            <!-- Products will be dynamically inserted here by JS -->
            <div class="placeholder">
                <h2>Welcome to AZIZIA STORE!</h2>
                <p>Click the <i class="ph-bold ph-gear"></i> icon in the top right to add your first product.</p>
            </div>
        </main>

        <!-- ALWAYS-VISIBLE CART PANEL -->
        <aside id="cart-panel">
            <div class="cart-header">
                <h2>Cart</h2>
                <span id="cart-total">Total: ৳0.00</span>
            </div>
            <div id="cart-items">
                <div class="cart-placeholder">Your cart is empty.</div>
            </div>
            <div class="cart-footer">
                <button id="checkout-btn" class="checkout-button" disabled>OK</button>
            </div>
        </aside>
    </div>

    <!-- MODAL FOR SETTINGS, SALES LOG, ETC. -->
    <div id="modal-overlay">
        <div id="modal-content">
            <button id="modal-close-btn" class="modal-close-button"><i class="ph-bold ph-x"></i></button>
            <div id="modal-body">
                <!-- Modal content will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- NOTIFICATION AREA -->
    <div id="notification-bar" class="notification-bar"></div>


    <script>
    // Wait for the DOM and external libraries to be ready
    window.addEventListener('DOMContentLoaded', () => {
        // Check if jsPDF is loaded
        if (typeof window.jspdf === 'undefined') {
            console.error("jsPDF not loaded!");
        }
        const { jsPDF } = window.jspdf || {};

        const app = {
            // --- STATE MANAGEMENT ---
            state: {
                products: [],
                cart: [], 
                sales: [], 
                settings: {
                    googleSheetUrl: 'https://script.google.com/macros/s/AKfycbzO-HRqUAC0CTEH9jN5TPIyNjqEvKMT-YTR9pfmKqYlAo84f1C8n8KXej-8sGpdRZpp/exec',
                    shopName: 'AZIZIA STORE',
                    currency: '৳',
                    geminiApiKey: '' // User-provided API Key
                },
            },

            // --- DOM ELEMENTS ---
            elements: {
                productGrid: document.getElementById('product-grid'),
                cartItems: document.getElementById('cart-items'),
                cartTotal: document.getElementById('cart-total'),
                checkoutBtn: document.getElementById('checkout-btn'),
                settingsBtn: document.getElementById('settings-btn'),
                salesLogBtn: document.getElementById('sales-log-btn'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalBody: document.getElementById('modal-body'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                notificationBar: document.getElementById('notification-bar'),
                topBarTitle: document.querySelector('.top-bar h1'),
            },

            // --- INITIALIZATION ---
            init() {
                this.loadState();
                this.renderAll();
                this.addEventListeners();
                console.log("AZIZIA STORE Assistant Initialized.");
            },

           // Inside your app object
async loadState() {
    // Load settings from localStorage first (like your Google Sheet URL)
    const savedSettings = localStorage.getItem('smartShopSettings');
    if (savedSettings) {
        this.state.settings = { ...this.state.settings, ...JSON.parse(savedSettings) };
    }

    // --- IMPORTANT CHANGE: Load products from Google Sheet ---
    if (this.state.settings.googleSheetUrl) {
        try {
            this.showNotification("Loading products from server...", false);
            const response = await fetch(this.state.settings.googleSheetUrl); // Makes a GET request to your Apps Script
            if (!response.ok) { // Check if the request was successful
              const errorText = await response.text();
              throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
            }
            const data = await response.json(); // Get the JSON data (your products)
            if (data.products) {
                this.state.products = data.products; // Update your app's product list
                this.showNotification("Products loaded successfully!");
            } else if (data.error) {
                 throw new Error(data.error);
            }
        } catch (error) {
            console.error("Failed to load products from Google Sheet:", error);
            this.showNotification(`Error loading products: ${error.message}. Using local storage.`, true);
            // Fallback: if there's a problem with the sheet, try loading from local storage
            const savedProducts = localStorage.getItem('smartShopProducts');
            if (savedProducts) {
                 this.state.products = JSON.parse(savedProducts);
            }
        }
    } else {
        // If no Google Sheet URL is set, only use local storage for products
        const savedProducts = localStorage.getItem('smartShopProducts');
        if (savedProducts) {
             this.state.products = JSON.parse(savedProducts);
        }
        this.showNotification("Google Sheet URL not configured. Using local storage for products only.", true);
    }

    // --- Keep these as they are, they load cart and sales data for the current session ---
    const savedCart = localStorage.getItem('smartShopCart');
    if (savedCart) { this.state.cart = JSON.parse(savedCart); }
    const savedSales = localStorage.getItem('smartShopSales');
    if (savedSales) { this.state.sales = JSON.parse(savedSales); }
},

            saveState() {
                localStorage.setItem('smartShopState', JSON.stringify(this.state));
            },

            // --- RENDERING ---
            renderAll() {
                this.renderProducts();
                this.renderCart();
                this.elements.topBarTitle.textContent = this.state.settings.shopName;
            },

            renderProducts() {
                this.elements.productGrid.innerHTML = '';
                if (this.state.products.length === 0) {
                    this.elements.productGrid.innerHTML = `
                        <div class="placeholder">
                            <h2>Welcome!</h2>
                            <p>Click the <i class="ph-bold ph-gear"></i> icon to add a product.</p>
                        </div>`;
                    return;
                }

                this.state.products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.dataset.id = product.id;
                    // Add 'out-of-stock' class if product stock is 0 or less
                    if (product.stock <= 0) {
                        card.classList.add('out-of-stock');
                    }

                    card.innerHTML = `
                        <img src="${product.imageUrl}" alt="${product.name}" onerror="this.src='https://placehold.co/200x200/e9e9eb/333?text=Image+Error'">
                        <div class="product-tooltip">
                            ${product.name}<br>
                            ${this.state.settings.currency}${product.prices.retail} | Stock: ${product.stock}
                        </div>
                    `;
                    card.addEventListener('click', () => this.addToCart(product.id));
                    this.elements.productGrid.appendChild(card);
                });
            },

            renderCart() {
                this.elements.cartItems.innerHTML = '';
                if (this.state.cart.length === 0) {
                    this.elements.cartItems.innerHTML = '<div class="cart-placeholder">Your cart is empty.</div>';
                    this.updateCartTotal();
                    return;
                }

                this.state.cart.forEach(item => {
                    const product = this.getProductById(item.productId);
                    if (!product) return;

                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.dataset.id = item.productId;
                    const pricePerUnit = this.getCartItemPrice(item);
                    // Calculate individual item total based on selected unit and quantity
                    const itemTotal = pricePerUnit * item.quantity;

                    itemEl.innerHTML = `
                        <button class="cart-item-delete-btn" title="Remove Item"><i class="ph-bold ph-x"></i></button>
                        <img src="${product.imageUrl}" alt="${product.name}" class="cart-item-img" onerror="this.src='https://placehold.co/50x50/e9e9eb/333?text=Err'">
                        <div class="cart-item-details">
                            <div class="cart-item-name">${product.name}</div>
                            <div class="cart-item-price">${this.state.settings.currency}${pricePerUnit.toFixed(2)} / ${item.unit === 'piece' ? 'pc' : 'ctn'}</div>
                            <div class="cart-item-total">Total: ${this.state.settings.currency}${itemTotal.toFixed(2)}</div>
                        </div>
                        <div class="cart-item-controls">
                            <div class="price-tier-selector">
                                <button data-tier="retail" class="${item.priceTier === 'retail' ? 'active' : ''}">R</button>
                                <button data-tier="wholesale" class="${item.priceTier === 'wholesale' ? 'active' : ''}">W</button>
                                <button data-tier="carton" class="${item.priceTier === 'carton' ? 'active' : ''}">C</button>
                            </div>
                            <div class="quantity-controls">
                                <button class="quantity-decrease">-</button>
                                <span class="quantity-value">${item.quantity}</span>
                                <button class="quantity-increase">+</button>
                                <span class="unit-selector" title="Switch Unit">${item.unit === 'piece' ? 'pc' : 'ctn'}</span>
                            </div>
                        </div>
                    `;
                    this.elements.cartItems.appendChild(itemEl);
                });
                this.updateCartTotal();
            },

            updateCartTotal() {
                const total = this.state.cart.reduce((sum, item) => {
                    const product = this.getProductById(item.productId);
                    if (!product) return sum;
                    // If unit is carton and price tier is carton, use carton price for total calculation
                    // Otherwise, use the price per piece for the selected tier
                    const pricePerEffectiveUnit = (item.unit === 'carton' && item.priceTier === 'carton') 
                                                ? product.prices.carton
                                                : (product.prices[item.priceTier] || product.prices.retail);
                    // Sum up based on the actual quantity of the purchased unit (piece or carton)
                    return sum + (pricePerEffectiveUnit * item.quantity);
                }, 0);
                
                this.elements.cartTotal.textContent = `Total: ${this.state.settings.currency}${total.toFixed(2)}`;
                this.elements.checkoutBtn.disabled = this.state.cart.length === 0;
            },

            // --- EVENT LISTENERS ---
            addEventListeners() {
                this.elements.modalCloseBtn.addEventListener('click', () => this.closeModal());
                this.elements.modalOverlay.addEventListener('click', (e) => {
                    if (e.target === this.elements.modalOverlay) this.closeModal();
                });
                this.elements.settingsBtn.addEventListener('click', () => this.showSettings());
                this.elements.salesLogBtn.addEventListener('click', () => this.showSalesLog());
                this.elements.checkoutBtn.addEventListener('click', () => this.processCheckout());

                this.elements.cartItems.addEventListener('click', e => {
                    const cartItemEl = e.target.closest('.cart-item');
                    if (!cartItemEl) return;
                    const productId = cartItemEl.dataset.id;
                    
                    if (e.target.closest('.cart-item-delete-btn')) { this.removeFromCart(productId); }
                    if (e.target.closest('.price-tier-selector')) {
                        const tier = e.target.dataset.tier;
                        if (tier) this.updateCartItem(productId, { priceTier: tier });
                    }
                    if (e.target.classList.contains('unit-selector')) { this.toggleCartItemUnit(productId); }

                    // Quantity button bug fix - change by 1 per click
                    if (e.target.classList.contains('quantity-increase')) {
                        this.updateCartItemQuantity(productId, 1);
                    }
                    if (e.target.classList.contains('quantity-decrease')) {
                        this.updateCartItemQuantity(productId, -1);
                    }
                });
            },

            // --- CART LOGIC ---
            addToCart(productId) {
                const product = this.getProductById(productId);
                if (!product || product.stock <= 0) {
                    this.showNotification('Item is out of stock.');
                    return;
                }
                const existingItem = this.state.cart.find(item => item.productId === productId && item.unit === 'piece');
                const totalInCart = this.getQuantityInPieces(productId);
                if (totalInCart >= product.stock) {
                    this.showNotification('Not enough stock!');
                    return;
                }
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    this.state.cart.push({ productId, quantity: 1, priceTier: 'retail', unit: 'piece' });
                }
                this.saveAndRender();
            },
            
            removeFromCart(productId) {
                this.state.cart = this.state.cart.filter(item => item.productId !== productId);
                this.saveAndRender();
            },

            updateCartItem(productId, updates) {
                const item = this.state.cart.find(i => i.productId === productId);
                if (item) {
                    Object.assign(item, updates);
                    this.saveAndRender();
                }
            },

            updateCartItemQuantity(productId, change) {
                const item = this.state.cart.find(i => i.productId === productId);
                if (!item) return;
                
                const product = this.getProductById(productId);
                const proposedNewQuantity = item.quantity + change;

                if (proposedNewQuantity < 1) {
                    // If quantity goes to 0 or less, remove item from cart
                    this.removeFromCart(productId);
                    return;
                }
                
                // Calculate new total pieces in cart for this product
                const currentQuantityInPiecesOfThisItem = item.unit === 'carton' ? item.quantity * product.cartonSize : item.quantity;
                const newQuantityInPiecesOfThisItem = item.unit === 'carton' ? proposedNewQuantity * product.cartonSize : proposedNewQuantity;
                
                // Get total of this product currently in cart (sum of all units/tiers)
                const totalPiecesOfProductInCartExcludingThisItem = this.getQuantityInPieces(productId) - currentQuantityInPiecesOfThisItem;
                const newTotalInCartForProduct = totalPiecesOfProductInCartExcludingThisItem + newQuantityInPiecesOfThisItem;
                
                if (newTotalInCartForProduct > product.stock) {
                    this.showNotification('Not enough stock!');
                    return;
                }
                
                item.quantity = proposedNewQuantity;
                this.saveAndRender();
            },
            
            toggleCartItemUnit(productId) {
                const item = this.state.cart.find(i => i.productId === productId);
                if (!item) return;
                const product = this.getProductById(productId);
                const newUnit = item.unit === 'piece' ? 'carton' : 'piece';

                // If switching to carton, ensure enough stock for at least one carton
                if (newUnit === 'carton' && product.stock < product.cartonSize) {
                    this.showNotification(`Not enough stock for a full carton.`);
                    return;
                }
                // If switching from carton to piece, and current quantity is 1 carton, convert to cartonSize pieces
                // Otherwise, just reset quantity to 1 for the new unit
                if (item.unit === 'carton' && newUnit === 'piece') {
                    item.quantity = item.quantity * product.cartonSize; // Convert cartons to pieces
                } else {
                    item.quantity = 1; // Default to 1 unit of new type
                }
                item.unit = newUnit;
                this.saveAndRender();
            },

            // --- CHECKOUT LOGIC ---
            async processCheckout() {
                if (this.state.cart.length === 0) return;

                let finalSaleTotal = 0;
                const itemsForSaleRecord = this.state.cart.map(item => {
                    const product = this.getProductById(item.productId);
                    if (!product) return null;

                    let effectivePricePerPiece = 0; // This is the price per single piece, used for total calculations
                    let pricePerUnitDisplayedOnReceipt = 0; // This is the price per unit shown on receipt (piece or carton)

                    if (item.unit === 'piece') {
                        effectivePricePerPiece = product.prices[item.priceTier] || product.prices.retail;
                        pricePerUnitDisplayedOnReceipt = effectivePricePerPiece; // For pieces, it's the same
                    } else if (item.unit === 'carton') {
                        pricePerUnitDisplayedOnReceipt = product.prices.carton || product.prices.retail; // Show carton price as unit price
                        effectivePricePerPiece = (product.prices.carton / product.cartonSize) || product.prices.retail; // Calculate price per piece from carton price
                    }

                    const quantityInPieces = item.unit === 'carton' ? item.quantity * product.cartonSize : item.quantity;
                    const itemTotal = effectivePricePerPiece * quantityInPieces; // This is the total for the line item based on pieces

                    // Update product stock based on quantity in pieces
                    product.stock -= quantityInPieces;

                    finalSaleTotal += itemTotal;

                    return {
                        productId: item.productId,
                        quantity: item.quantity, // Quantity of the unit purchased (e.g., 2 if 2 cartons, or 5 if 5 pieces)
                        unit: item.unit, // 'piece' or 'carton'
                        priceTier: item.priceTier,
                        pricePerPieceAtSale: effectivePricePerPiece, // The actual price per piece at sale
                        pricePerUnitDisplayedOnReceipt: pricePerUnitDisplayedOnReceipt, // The price displayed for the unit on receipt
                        quantityInPieces: quantityInPieces, // Total actual pieces
                        itemTotal: itemTotal // Total for this specific line item
                    };
                }).filter(item => item !== null);

                const saleRecord = {
                    id: `sale_${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    items: itemsForSaleRecord, // Use the prepared items
                    total: finalSaleTotal, // Use the calculated final total
                    currency: this.state.settings.currency,
                    shopName: this.state.settings.shopName,
                };
                
                this.state.sales.unshift(saleRecord); 
                this.state.cart = []; // Clear cart after checkout
                this.saveAndRender(); // Save state and re-render UI

                // Generate receipt and sync to Google Sheets
                this.generateReceipt(saleRecord);
                
                // Show notification for the first item sold (or a generic message)
                if (saleRecord.items.length > 0) {
                    const firstSoldItem = saleRecord.items[0];
                    const product = this.getProductById(firstSoldItem.productId);
                    if (product) this.showNotification(`${firstSoldItem.quantity} × ${product.name} sold.`);
                } else {
                    this.showNotification("Checkout processed.");
                }

                if (this.state.settings.googleSheetUrl) {
                    try {
                        await this.syncToGoogleSheets(saleRecord);
                    } catch (error) {
                        console.error("Failed to sync to Google Sheets:", error);
                        this.showNotification("Error: Failed to sync sale.", true);
                    }
                }
            },

            // --- GOOGLE SHEETS & RECEIPT ---
            syncToGoogleSheets(saleRecord) {
                const dataForSheet = saleRecord.items.map(item => {
                    const product = this.getProductById(item.productId);
                    // Use item.pricePerPieceAtSale and item.itemTotal from saleRecord directly
                    return {
                        timestamp: saleRecord.timestamp,
                        productName: product ? product.name : 'N/A',
                        quantity: item.quantity,
                        unit: item.unit,
                        priceTier: item.priceTier,
                        pricePerPiece: item.pricePerPieceAtSale,
                        itemTotal: item.itemTotal
                    };
                });
                return fetch(this.state.settings.googleSheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sales: dataForSheet })
                });
            },

            generateReceipt(saleRecord) {
                if (!jsPDF) {
                    this.showNotification("PDF library not loaded. Cannot generate receipt.", true);
                    return;
                }
                const doc = new jsPDF();
                doc.setFontSize(20);
                doc.text(`${saleRecord.shopName} Receipt`, 105, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Date: ${new Date(saleRecord.timestamp).toLocaleString()}`, 10, 30);
                let y = 45;
                doc.line(10, 40, 200, 40);
                doc.text("Item", 10, y);
                doc.text("Qty", 80, y); 
                doc.text("Unit Price", 120, y); 
                doc.text("Total", 170, y, {align: 'right'});
                y += 7;
                doc.line(10, y-5, 200, y-5);
                
                saleRecord.items.forEach(item => {
                    const product = this.getProductById(item.productId);
                    if (!product) return; 

                    // Display quantity of the purchased unit (e.g., "10 pc" or "2 ctn")
                    const displayQuantityAndUnit = `${item.quantity} ${item.unit === 'piece' ? 'pc' : 'ctn'}`;
                    
                    doc.text(product.name, 10, y);
                    doc.text(displayQuantityAndUnit, 80, y); 
                    // Display only the unit price without the currency symbol, as requested
                    doc.text(`${item.pricePerUnitDisplayedOnReceipt.toFixed(2)}`, 120, y); 
                    doc.text(`${item.itemTotal.toFixed(2)}`, 170, y, { align: 'right' });
                    y += 7;
                });
                doc.line(10, y, 200, y);
                y += 7;
                doc.setFontSize(16);
                // Display only the grand total without the currency symbol, as requested
                doc.text(`Grand Total: ${saleRecord.total.toFixed(2)}`, 170, y, { align: 'right' });
                doc.autoPrint();
                doc.output('dataurlnewwindow');
            },
            
            // --- GEMINI API INTEGRATION ---
            async callGemini(prompt, buttonToDisable, resultContainer) {
                const apiKey = this.state.settings.geminiApiKey || "";

                if (!apiKey) {
                    this.showNotification("Please add your Gemini API Key in the Settings.", true);
                    return null;
                }

                buttonToDisable.disabled = true;
                resultContainer.innerHTML = '<div class="loading-spinner"></div>';

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    const data = await response.json();
                    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("No content received from API.");
                    return text;
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    resultContainer.innerHTML = `<p style="color:var(--danger-color)">Error: ${error.message}</p>`;
                    return null;
                } finally {
                    buttonToDisable.disabled = false;
                    if(resultContainer.querySelector('.loading-spinner')) {
                        resultContainer.innerHTML = '';
                    }
                }
            },

            async generateProductDescription(event) {
                const form = event.target.closest('form');
                const productName = form.querySelector('#name').value;
                if (!productName) {
                    this.showNotification("Please enter a product name first.", true);
                    return;
                }
                const prompt = `Generate a short, engaging product description for a product named "${productName}". Keep it under 150 characters.`;
                const description = await this.callGemini(prompt, event.target, document.createElement('div')); // Dummy div
                if (description) {
                    form.querySelector('#description').value = description;
                    this.showNotification("Description generated!");
                }
            },

            async analyzeSales(event) {
                if (this.state.sales.length === 0) {
                    this.showNotification("No sales data to analyze.", true);
                    return;
                }
                const salesData = this.state.sales.map(sale => ({
                    date: new Date(sale.timestamp).toLocaleDateString(),
                    total: sale.total,
                    items: sale.items.map(item => {
                        const product = this.getProductById(item.productId);
                        return `${item.quantity}x ${product ? product.name : 'Unknown'}`;
                    })
                }));
                const prompt = `Analyze the following JSON sales data from a small retail shop. Provide a brief summary of key insights. Mention the best-selling product (by quantity sold if possible), total revenue, and any notable trends in 2-3 bullet points. Data: ${JSON.stringify(salesData.slice(0, 20))}`; // Limit data for prompt length
                const resultContainer = document.getElementById('sales-analysis-result');
                const analysis = await this.callGemini(prompt, event.target, resultContainer);
                if (analysis) {
                    resultContainer.innerHTML = `<div class="ai-result-box">${analysis}</div>`;
                }
            },
            
            async getRestockSuggestions(event) {
                const productData = this.state.products.map(p => ({
                    name: p.name,
                    stock: p.stock
                }));

                const salesHistory = this.state.sales.flatMap(s => s.items).reduce((acc, item) => {
                    const productName = this.getProductById(item.productId)?.name;
                    if(productName){
                        acc[productName] = (acc[productName] || 0) + (item.unit === 'carton' ? item.quantity * this.getProductById(item.productId).cartonSize : item.quantity);
                    }
                    return acc;
                }, {});

                const prompt = `Based on the current inventory and sales history, suggest the top 3 products to restock. Give a brief, one-sentence reason for each. Current Inventory: ${JSON.stringify(productData)}. Sales History (product: total quantity sold): ${JSON.stringify(salesHistory)}`;
                const resultContainer = document.getElementById('restock-suggestions-result');
                const suggestions = await this.callGemini(prompt, event.target, resultContainer);
                if (suggestions) {
                    resultContainer.innerHTML = `<div class="ai-result-box">${suggestions}</div>`;
                }
            },


            // --- MODAL & UI ---
            openModal(content) {
                this.elements.modalBody.innerHTML = content;
                this.elements.modalOverlay.classList.add('visible');
            },

            closeModal() {
                this.elements.modalOverlay.classList.remove('visible');
            },

            showSettings() {
                const productsListHtml = this.state.products.map(p => `
                    <li>
                        <span>${p.name} (Stock: ${p.stock})</span>
                        <div><button class="btn btn-secondary" onclick="app.showEditProductForm('${p.id}')">Edit</button></div>
                    </li>`).join('');

                const content = `
                    <h2>Settings</h2>
                    <div class="form-section">
                        <h3>General</h3>
                        <div class="form-group">
                            <label for="shop-name">Shop Name</label>
                            <input type="text" id="shop-name" value="${this.state.settings.shopName}">
                        </div>
                         <div class="form-group">
                            <label for="currency-symbol">Currency Symbol</label>
                            <input type="text" id="currency-symbol" value="${this.state.settings.currency}">
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>AI Settings</h3>
                        <div class="form-group">
                            <label for="gemini-api-key">Gemini API Key</label>
                            <input type="password" id="gemini-api-key" value="${this.state.settings.geminiApiKey}" placeholder="Enter your Gemini API key">
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>Google Sheets Sync</h3>
                        <div class="form-group">
                            <label for="google-sheet-url">Google Apps Script Web App URL</label>
                            <input type="url" id="google-sheet-url" value="${this.state.settings.googleSheetUrl}" placeholder="Paste Web App URL (optional)">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="app.saveAppSettings()">Save All Settings</button>
                    
                    <div class="form-section" id="product-list-settings">
                        <h3>Products</h3>
                        <ul>${productsListHtml || '<li>No products yet.</li>'}</ul>
                        <div class="settings-actions">
                            <button class="btn btn-primary" onclick="app.showAddProductForm()">Add New Product</button>
                            <button class="btn btn-ai" onclick="app.getRestockSuggestions(event)">✨ Get Restock Suggestions</button>
                        </div>
                        <div id="restock-suggestions-result"></div>
                    </div>`;
                this.openModal(content);
            },
            
            saveAppSettings() {
                this.state.settings.shopName = document.getElementById('shop-name').value;
                this.state.settings.currency = document.getElementById('currency-symbol').value;
                this.state.settings.geminiApiKey = document.getElementById('gemini-api-key').value;
                this.state.settings.googleSheetUrl = document.getElementById('google-sheet-url').value;
                this.saveAndRender();
                this.showNotification('Settings saved!');
                this.closeModal();
            },

            showAddProductForm() { this.showEditProductForm(null); },

            showEditProductForm(productId) {
                const product = this.getProductById(productId) || {};
                const isEditing = !!productId;

                const content = `
                    <h2>${isEditing ? 'Edit Product' : 'Add New Product'}</h2>
                    <form id="product-form" onsubmit="event.preventDefault(); app.saveProduct(new FormData(event.target));">
                        <input type="hidden" name="id" value="${product.id || ''}">
                        <div class="form-group">
                            <label for="name">Product Name</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="name" name="name" value="${product.name || ''}" required style="flex-grow: 1;">
                                <button type="button" class="btn btn-ai" onclick="app.generateProductDescription(event)">✨</button>
                            </div>
                        </div>
                         <div class="form-group">
                            <label for="description">Product Description</label>
                            <textarea id="description" name="description">${product.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="image">Product Image (Leave empty to keep existing)</label>
                            <input type="file" id="image" name="image" accept="image/*">
                            ${isEditing && product.imageUrl ? `<img src="${product.imageUrl}" style="max-width: 100px; margin-top: 10px; border-radius: 8px;">` : ''}
                        </div>
                        <div class="form-group">
                            <label>Price Tiers (per piece)</label>
                            <div class="price-tier-inputs">
                                <input type="number" name="priceRetail" placeholder="Retail" value="${product.prices?.retail || ''}" required step="0.01">
                                <input type="number" name="priceWholesale" placeholder="Wholesale" value="${product.prices?.wholesale || ''}" required step="0.01">
                                <input type="number" name="priceCarton" placeholder="Carton" value="${product.prices?.carton || ''}" required step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="stock">Quantity Available (in pieces)</label>
                            <input type="number" id="stock" name="stock" value="${product.stock || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="cartonSize">Pieces per Carton</label>
                            <input type="number" id="cartonSize" name="cartonSize" value="${product.cartonSize || ''}" required>
                        </div>
                        <div class="settings-actions">
                             <button type="submit" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Add Product'}</button>
                             ${isEditing ? `<button type="button" class="btn btn-danger" onclick="app.deleteProduct('${product.id}')">Delete</button>` : ''}
                             <button type="button" class="btn btn-secondary" onclick="app.showSettings()">Cancel</button>
                        </div>
                    </form>
                `;
                this.openModal(content);
            },

           async saveProduct(formData) {
            const imageFile = formData.get('image');
            const productId = formData.get('id'); // Will be empty for new products

            let imageUrl = this.getProductById(productId)?.imageUrl || ''; // Keep existing image URL

            // --- IMPORTANT NOTE ABOUT IMAGES ---
            // You CANNOT directly upload images to Google Sheets.
            // You need to upload images to an image hosting service (like Imgur, Cloudinary, or even a publicly shared Google Drive link).
            // Then, you store the *link* (URL) to that image in your Google Sheet's 'imageUrl' column.
            // Your current code handles reading image as Base64, but that data is too large for Google Sheets cells
            // and is not good for performance.
            if (imageFile && imageFile.size > 0) {
                this.showNotification('Image upload needs a separate service (e.g., Imgur). Storing only image URL in sheet.', true);
                // If you implement an image upload service, you would put that code here
                // Example: imageUrl = await uploadImageToMyImageHost(imageFile);
                // For now, if you want an image, you'll need to manually paste its URL into the product form.
                // Or remove the image input if you don't plan on integrating an image host.
            }

            const productData = {
                id: productId || `prod_${Date.now()}`, // Generate new ID for new products
                name: formData.get('name'),
                description: formData.get('description'),
                imageUrl: imageUrl || 'https://placehold.co/200x200/e9e9eb/333?text=No+Image', // Default placeholder if no image URL
                prices: {
                    retail: parseFloat(formData.get('priceRetail')) || 0,
                    wholesale: parseFloat(formData.get('priceWholesale')) || 0,
                    carton: parseFloat(formData.get('priceCarton')) || 0,
                },
                stock: parseInt(formData.get('stock')) || 0,
                cartonSize: parseInt(formData.get('cartonSize')) || 1, // Default cartonSize to 1
            };

            // --- Check if Google Sheet URL is set before trying to save ---
            if (!this.state.settings.googleSheetUrl) {
                this.showNotification("Google Sheet URL not configured. Product will only save locally.", true);
                // Fallback to local storage for testing
                const existingIndex = this.state.products.findIndex(p => p.id === productData.id);
                if (existingIndex > -1) {
                    this.state.products[existingIndex] = productData;
                } else {
                    this.state.products.push(productData);
                }
                this.saveState(); // Save to browser's local storage
                this.renderAll();
                this.showSettings();
                return;
            }

            try {
                const action = productId ? 'updateProduct' : 'addProduct'; // Determine if we're adding or updating
                this.showNotification(`Saving product to server...`, false);

                // Send product data to your Google Apps Script
                const response = await fetch(this.state.settings.googleSheetUrl, {
                    method: 'POST', // We are sending data
                    mode: 'no-cors', // Use 'no-cors' to avoid browser CORS errors, but you won't get a clear response.
                                    // If you set up CORS headers in Apps Script, you could use 'cors' and get a response.
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, product: productData }) // Send action and product data
                });

                this.showNotification(`Product ${productId ? 'updated' : 'added'} successfully!`);
                // After saving, reload all products from the sheet to update your website's view
                await this.loadState();
                this.renderAll();
                this.showSettings(); // Go back to settings view
            } catch (error) {
                console.error("Failed to save product to Google Sheet:", error);
                this.showNotification(`Error saving product: ${error.message}`, true);
            }
        }, // <--- Make sure this comma is there if another function follows
          async deleteProduct(productId) {
            if (!confirm("Are you sure you want to delete this product?")) {
                return;
            }

            // --- Check if Google Sheet URL is set before trying to delete ---
            if (!this.state.settings.googleSheetUrl) {
                this.showNotification("Google Sheet URL not configured. Cannot delete product persistently.", true);
                // Fallback to local storage for testing
                this.state.products = this.state.products.filter(p => p.id !== productId);
                this.saveState(); // Save to browser's local storage
                this.renderAll();
                this.showSettings();
                return;
            }

            try {
                this.showNotification("Deleting product from server...", false);
                // Send delete request to your Google Apps Script
                const response = await fetch(this.state.settings.googleSheetUrl, {
                    method: 'POST',
                    mode: 'no-cors', // or 'cors'
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deleteProduct', productId: productId }) // Send delete action and product ID
                });
                
                this.showNotification("Product deleted successfully.");
                await this.loadState(); // Reload products from the sheet to update UI
                this.renderAll();
                this.showSettings();
            } catch (error) {
                console.error("Failed to delete product from Google Sheet:", error);
                this.showNotification(`Error deleting product: ${error.message}`, true);
            }
        }, // <--- Make sure this comma is there if another function follows
            showSalesLog() {
                const content = `
                    <h2>Sales Log</h2>
                    <div class="sales-log-filters">
                        <input type="date" id="filter-date" class="form-group">
                        <button class="btn btn-secondary" onclick="app.filterSalesLog()">Filter</button>
                        <button class="btn btn-secondary" onclick="app.filterSalesLog(true)">Show All</button>
                        <button class="btn btn-ai" onclick="app.analyzeSales(event)">✨ Analyze Sales</button>
                    </div>
                    <div id="sales-analysis-result"></div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="sales-log-table">
                            <thead>
                                <tr><th>Time</th><th>Details</th><th>Total</th></tr>
                            </thead>
                            <tbody id="sales-log-body">
                                ${this.generateSalesLogRows(this.state.sales)}
                            </tbody>
                        </table>
                    </div>`;
                this.openModal(content);
            },
            
            generateSalesLogRows(sales) {
                if (sales.length === 0) return '<tr><td colspan="3" style="text-align:center; padding: 20px;">No sales recorded yet.</td></tr>';
                return sales.map(sale => {
                    const details = sale.items.map(item => {
                        const product = this.getProductById(item.productId);
                        // Display quantity with 'pc' or 'ctn' and remove price tier
                        const displayQty = item.unit === 'carton' ? `${item.quantity} ctn (${item.quantityInPieces} pc)` : `${item.quantity} pc`;
                        return `${displayQty} × ${product ? product.name : 'Deleted'}`; 
                    }).join('<br>');
                    
                    return `
                        <tr>
                            <td>${new Date(sale.timestamp).toLocaleTimeString()} <br> <small>${new Date(sale.timestamp).toLocaleDateString()}</small></td>
                            <td>${details}</td>
                            <td>${sale.currency || '৳'}${sale.total.toFixed(2)}</td>
                        </tr>`;
                }).join('');
            },

            filterSalesLog(reset = false) {
                const dateFilter = document.getElementById('filter-date').value;
                let filteredSales = this.state.sales;
                if (!reset && dateFilter) {
                    filteredSales = this.state.sales.filter(sale => new Date(sale.timestamp).toISOString().split('T')[0] === dateFilter);
                }
                document.getElementById('sales-log-body').innerHTML = this.generateSalesLogRows(filteredSales);
            },

            // --- UTILITY FUNCTIONS ---
            saveAndRender() {
                this.saveState();
                this.renderAll();
            },
            getProductById(id) { return this.state.products.find(p => p.id === id); },
            getCartItemPrice(cartItem) {
                const product = this.getProductById(cartItem.productId);
                if (!product) return 0;
                // Returns the price for one unit of the selected type (piece or carton) based on the price tier.
                // This is used for displaying the price in the cart.
                if (cartItem.unit === 'carton') {
                    return product.prices.carton || product.prices.retail; 
                }
                return product.prices[cartItem.priceTier] || product.prices.retail;
            },
            getQuantityInPieces(productId) {
                return this.state.cart
                    .filter(item => item.productId === productId)
                    .reduce((total, item) => {
                        const product = this.getProductById(productId);
                        return total + (product ? (item.unit === 'carton' ? item.quantity * product.cartonSize : item.quantity) : 0);
                    }, 0);
            },
            readImageAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            },
            showNotification(message, isError = false) {
                const bar = this.elements.notificationBar;
                bar.textContent = message;
                bar.style.backgroundColor = isError ? 'var(--danger-color)' : 'rgba(0,0,0,0.8)';
                bar.classList.add('show');
                setTimeout(() => bar.classList.remove('show'), 3000);
            }
        };

        window.app = app; 
        app.init();
    });
    </script>
</body>
</html>

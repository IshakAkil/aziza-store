<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZIZIA STORE Assistant</title>
    
    <!-- External Libraries: Icons (Phosphor) and PDF Generator (jsPDF) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- ALL YOUR EXISTING CSS IS HERE --- */
        :root {
            --bg-color: #f0f2f5;
            --panel-color: #ffffff;
            --text-color: #1c1e21;
            --primary-color: #007aff;
            --secondary-color: #e9e9eb;
            --border-color: #dcdfe3;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545;
            --ai-color: #8e44ad;
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* ... [unchanged CSS, omitted for brevity] ... */
    </style>
</head>
<body>
    <div id="app-container">
        <!-- TOP BAR WITH ICONS -->
        <header class="top-bar">
            <h1>AZIZIA STORE</h1>
            <div class="top-bar-icons">
                <button id="sales-log-btn" title="Sales Log"><i class="ph-bold ph-list-dashes"></i></button>
                <button id="settings-btn" title="Settings & AI Tools"><i class="ph-bold ph-gear"></i></button>
            </div>
        </header>

        <!-- MAIN PRODUCT DISPLAY -->
        <main id="product-grid">
            <!-- Products will be dynamically inserted here by JS -->
            <div class="placeholder">
                <h2>Welcome to AZIZIA STORE!</h2>
                <p>Click the <i class="ph-bold ph-gear"></i> icon in the top right to add your first product.</p>
            </div>
        </main>

        <!-- ALWAYS-VISIBLE CART PANEL -->
        <aside id="cart-panel">
            <div class="cart-header">
                <h2>Cart</h2>
                <span id="cart-total">Total: ৳0.00</span>
            </div>
            <div id="cart-items">
                <div class="cart-placeholder">Your cart is empty.</div>
            </div>
            <div class="cart-footer">
                <button id="checkout-btn" class="checkout-button" disabled>OK</button>
            </div>
        </aside>
    </div>

    <!-- MODAL FOR SETTINGS, SALES LOG, ETC. -->
    <div id="modal-overlay">
        <div id="modal-content">
            <button id="modal-close-btn" class="modal-close-button"><i class="ph-bold ph-x"></i></button>
            <div id="modal-body">
                <!-- Modal content will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- NOTIFICATION AREA -->
    <div id="notification-bar" class="notification-bar"></div>


    <script>
    // FIX: Safe jsPDF loading
    let jsPDF;
    if (window.jspdf && window.jspdf.jsPDF) {
        jsPDF = window.jspdf.jsPDF;
    } else {
        console.error("jsPDF not loaded!");
    }

    // FIX: Safe product property access helper
    function safeProduct(product) {
        return {
            name: product?.name || "Unnamed",
            prices: {
                retail: Number(product?.prices?.retail) || 0,
                wholesale: Number(product?.prices?.wholesale) || 0,
                carton: Number(product?.prices?.carton) || 0
            },
            stock: Number(product?.stock) || 0,
            cartonSize: Number(product?.cartonSize) || 1,
            imageUrl: product?.imageUrl || 'https://placehold.co/200x200/e9e9eb/333?text=Image+Error',
            id: product?.id
        }
    }

    // FIX: Robust safeParse for localStorage
    function safeParse(json, fallback) {
        try { return JSON.parse(json); }
        catch { return fallback; }
    }

    window.addEventListener('DOMContentLoaded', () => {

        const app = {
            // --- STATE MANAGEMENT ---
            state: {
                products: [],
                cart: [],
                sales: [],
                settings: {
                    googleSheetUrl: '',
                    shopName: 'AZIZIA STORE',
                    currency: '৳',
                    geminiApiKey: ''
                },
            },

            // --- DOM ELEMENTS ---
            elements: {
                productGrid: document.getElementById('product-grid'),
                cartItems: document.getElementById('cart-items'),
                cartTotal: document.getElementById('cart-total'),
                checkoutBtn: document.getElementById('checkout-btn'),
                settingsBtn: document.getElementById('settings-btn'),
                salesLogBtn: document.getElementById('sales-log-btn'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalBody: document.getElementById('modal-body'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                notificationBar: document.getElementById('notification-bar'),
                topBarTitle: document.querySelector('.top-bar h1'),
            },

            async init() { 
                await this.loadState();
                this.renderAll();
                this.addEventListeners();
                // FIX: Modal accessibility for Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeModal();
                });
                console.log("AZIZIA STORE Assistant Initialized.");
            },

            async loadState() {
                // FIX: Robust settings loading
                const savedSettings = safeParse(localStorage.getItem('smartShopSettings'), null);
                if (savedSettings) {
                    this.state.settings = { ...this.state.settings, ...savedSettings };
                }

                if (this.state.settings.googleSheetUrl) {
                    try {
                        this.showNotification("Loading data from server...", false);

                        const productsResponse = await fetch(this.state.settings.googleSheetUrl + '?action=getProducts');
                        if (!productsResponse.ok) {
                            const errorText = await productsResponse.text();
                            throw new Error(`HTTP error (products)! status: ${productsResponse.status} - ${errorText}`);
                        }
                        const productsData = await productsResponse.json();
                        if (productsData.products) {
                            this.state.products = productsData.products;
                        } else if (productsData.error) {
                            throw new Error(productsData.error);
                        }

                        const salesResponse = await fetch(this.state.settings.googleSheetUrl + '?action=getSales');
                        if (!salesResponse.ok) {
                            const errorText = await salesResponse.text();
                            throw new Error(`HTTP error (sales)! status: ${salesResponse.status} - ${errorText}`);
                        }
                        const salesData = await salesResponse.json();
                        if (salesData.sales) {
                            this.state.sales = salesData.sales;
                        } else if (salesData.error) {
                            throw new Error(salesData.error);
                        }

                        this.showNotification("Data loaded successfully!");

                    } catch (error) {
                        console.error("Failed to load data from Google Sheet:", error);
                        this.showNotification(`Error loading data from server: ${error.message}. Using local storage as fallback.`, true);

                        // FIX: Robust fallback
                        const savedProducts = safeParse(localStorage.getItem('smartShopProducts'), []);
                        this.state.products = savedProducts;
                        const savedSalesLocal = safeParse(localStorage.getItem('smartShopSales'), []);
                        this.state.sales = savedSalesLocal;
                    }
                } else {
                    // FIX: Robust fallback
                    const savedProducts = safeParse(localStorage.getItem('smartShopProducts'), []);
                    this.state.products = savedProducts;
                    const savedSalesLocal = safeParse(localStorage.getItem('smartShopSales'), []);
                    this.state.sales = savedSalesLocal;
                    this.showNotification("Google Sheet URL not configured. Using local storage only.", true);
                }

                const savedCart = safeParse(localStorage.getItem('smartShopCart'), []);
                this.state.cart = savedCart;
            },

            saveState() {
                localStorage.setItem('smartShopSettings', JSON.stringify(this.state.settings)); 
                localStorage.setItem('smartShopCart', JSON.stringify(this.state.cart));       
                localStorage.setItem('smartShopSales', JSON.stringify(this.state.sales));
            },

            renderAll() {
                this.renderProducts();
                this.renderCart();
                this.elements.topBarTitle.textContent = this.state.settings.shopName;
            },

            renderProducts() {
                this.elements.productGrid.innerHTML = '';
                if (this.state.products.length === 0) {
                    this.elements.productGrid.innerHTML = `
                        <div class="placeholder">
                            <h2>Welcome!</h2>
                            <p>Click the <i class="ph-bold ph-gear"></i> icon to add a product.</p>
                        </div>`;
                    return;
                }

                this.state.products.forEach(p => {
                    const product = safeProduct(p);
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.dataset.id = product.id;
                    // Out of stock state
                    if (product.stock <= 0) card.classList.add('out-of-stock');

                    card.innerHTML = `
                        <img src="${product.imageUrl}" alt="${product.name}" onerror="this.src='https://placehold.co/200x200/e9e9eb/333?text=Image+Error'">
                        <div class="product-tooltip">
                            ${product.name}<br>
                            ${this.state.settings.currency}${product.prices.retail.toFixed(2)} | Stock: ${product.stock}
                        </div>
                    `;
                    card.addEventListener('click', () => this.addToCart(product.id));
                    this.elements.productGrid.appendChild(card);
                });
            },

            renderCart() {
                this.elements.cartItems.innerHTML = '';
                if (this.state.cart.length === 0) {
                    this.elements.cartItems.innerHTML = '<div class="cart-placeholder">Your cart is empty.</div>';
                    this.updateCartTotal();
                    return;
                }

                this.state.cart.forEach(item => {
                    const product = safeProduct(this.getProductById(item.productId));
                    if (!product) return;

                    const pricePerUnit = this.getCartItemPrice(item, product);
                    const itemTotal = pricePerUnit * item.quantity;

                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.dataset.id = item.productId;

                    itemEl.innerHTML = `
                        <button class="cart-item-delete-btn" title="Remove Item"><i class="ph-bold ph-x"></i></button>
                        <img src="${product.imageUrl}" alt="${product.name}" class="cart-item-img" onerror="this.src='https://placehold.co/50x50/e9e9eb/333?text=Err'">
                        <div class="cart-item-details">
                            <div class="cart-item-name">${product.name}</div>
                            <div class="cart-item-price">${this.state.settings.currency}${pricePerUnit.toFixed(2)} / ${item.unit === 'piece' ? 'pc' : 'ctn'}</div>
                            <div class="cart-item-total">Total: ${this.state.settings.currency}${itemTotal.toFixed(2)}</div>
                        </div>
                        <div class="cart-item-controls">
                            <div class="price-tier-selector">
                                <button data-tier="retail" class="${item.priceTier === 'retail' ? 'active' : ''}">R</button>
                                <button data-tier="wholesale" class="${item.priceTier === 'wholesale' ? 'active' : ''}">W</button>
                                <button data-tier="carton" class="${item.priceTier === 'carton' ? 'active' : ''}">C</button>
                            </div>
                            <div class="quantity-controls">
                                <button class="quantity-decrease">-</button>
                                <span class="quantity-value">${item.quantity}</span>
                                <button class="quantity-increase">+</button>
                                <span class="unit-selector" title="Switch Unit">${item.unit === 'piece' ? 'pc' : 'ctn'}</span>
                            </div>
                        </div>
                    `;
                    this.elements.cartItems.appendChild(itemEl);
                });
                this.updateCartTotal();
            },

            updateCartTotal() {
                const total = this.state.cart.reduce((sum, item) => {
                    const product = safeProduct(this.getProductById(item.productId));
                    if (!product) return sum;
                    const pricePerEffectiveUnit = (item.unit === 'carton' && item.priceTier === 'carton') 
                                                ? (product.prices.carton || product.prices.retail)
                                                : (product.prices[item.priceTier] || product.prices.retail);
                    return sum + (pricePerEffectiveUnit * item.quantity);
                }, 0);

                // FIX: Only enable checkout if cart has valid stock items
                const cartHasValidItems = this.state.cart.some(item => {
                    const product = safeProduct(this.getProductById(item.productId));
                    return product && product.stock > 0;
                });
                this.elements.checkoutBtn.disabled = !cartHasValidItems;
                
                this.elements.cartTotal.textContent = `Total: ${this.state.settings.currency}${total.toFixed(2)}`;
            },

            addEventListeners() {
                this.elements.modalCloseBtn.addEventListener('click', () => this.closeModal());
                this.elements.modalOverlay.addEventListener('click', (e) => {
                    if (e.target === this.elements.modalOverlay) this.closeModal();
                });
                this.elements.settingsBtn.addEventListener('click', () => this.showSettings());
                this.elements.salesLogBtn.addEventListener('click', () => this.showSalesLog());
                this.elements.checkoutBtn.addEventListener('click', () => this.processCheckout());

                this.elements.cartItems.addEventListener('click', e => {
                    const cartItemEl = e.target.closest('.cart-item');
                    if (!cartItemEl) return;
                    const productId = cartItemEl.dataset.id;

                    if (e.target.closest('.cart-item-delete-btn')) { this.removeFromCart(productId); }
                    if (e.target.closest('.price-tier-selector')) {
                        const tier = e.target.dataset.tier;
                        if (tier) this.updateCartItem(productId, { priceTier: tier });
                    }
                    if (e.target.classList.contains('unit-selector')) { this.toggleCartItemUnit(productId); }

                    if (e.target.classList.contains('quantity-increase')) {
                        this.updateCartItemQuantity(productId, 1);
                    }
                    if (e.target.classList.contains('quantity-decrease')) {
                        this.updateCartItemQuantity(productId, -1);
                    }
                });
            },

            getProductById(productId) {
                return this.state.products.find(p => p.id == productId);
            },

            // FIX: Defensive getCartItemPrice
            getCartItemPrice(item, product) {
                if (!product) return 0;
                if (item.unit === 'carton' && item.priceTier === 'carton') {
                    return product.prices.carton || product.prices.retail;
                }
                return product.prices[item.priceTier] || product.prices.retail;
            },

            // --- CART LOGIC ---
            addToCart(productId) {
                const product = safeProduct(this.getProductById(productId));
                if (!product || product.stock <= 0) {
                    this.showNotification('Item is out of stock.', true);
                    return;
                }
                const existingItem = this.state.cart.find(item => item.productId === productId && item.unit === 'piece');
                const totalInCart = this.getQuantityInPieces(productId);
                if (totalInCart >= product.stock) {
                    this.showNotification('Not enough stock!', true);
                    return;
                }
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    this.state.cart.push({ productId, quantity: 1, priceTier: 'retail', unit: 'piece' });
                }
                this.saveState();
                this.renderAll();
            },
            
            removeFromCart(productId) {
                this.state.cart = this.state.cart.filter(item => item.productId !== productId);
                this.saveState();
                this.renderAll();
            },

            updateCartItem(productId, updates) {
                const item = this.state.cart.find(i => i.productId === productId);
                if (item) {
                    Object.assign(item, updates);
                    this.saveState();
                    this.renderAll();
                }
            },

            updateCartItemQuantity(productId, change) {
                const item = this.state.cart.find(i => i.productId === productId);
                if (!item) return;

                const product = safeProduct(this.getProductById(productId));
                const proposedNewQuantity = item.quantity + change;

                if (proposedNewQuantity < 1) {
                    this.removeFromCart(productId);
                    return;
                }

                const currentQuantityInPiecesOfThisItem = item.unit === 'carton' ? item.quantity * product.cartonSize : item.quantity;
                const newQuantityInPiecesOfThisItem = item.unit === 'carton' ? proposedNewQuantity * product.cartonSize : proposedNewQuantity;

                const totalPiecesOfProductInCartExcludingThisItem = this.getQuantityInPieces(productId) - currentQuantityInPiecesOfThisItem;
                const newTotalInCartForProduct = totalPiecesOfProductInCartExcludingThisItem + newQuantityInPiecesOfThisItem;

                if (newTotalInCartForProduct > product.stock) {
                    this.showNotification('Not enough stock!', true);
                    return;
                }

                item.quantity = proposedNewQuantity;
                this.saveState();
                this.renderAll();
            },
            
            toggleCartItemUnit(productId) {
                const item = this.state.cart.find(i => i.productId === productId);
                if (!item) return;
                const product = safeProduct(this.getProductById(productId));
                const newUnit = item.unit === 'piece' ? 'carton' : 'piece';

                if (newUnit === 'carton' && product.stock < product.cartonSize) {
                    this.showNotification(`Not enough stock for a full carton.`, true);
                    return;
                }
                if (item.unit === 'carton' && newUnit === 'piece') {
                    item.quantity = item.quantity * product.cartonSize; 
                } else {
                    item.quantity = 1; 
                }
                item.unit = newUnit;
                this.saveState();
                this.renderAll();
            },

            getQuantityInPieces(productId) {
                return this.state.cart
                    .filter(item => item.productId === productId)
                    .reduce((sum, item) => {
                        const product = safeProduct(this.getProductById(productId));
                        return sum + (item.unit === 'carton' ? item.quantity * product.cartonSize : item.quantity);
                    }, 0);
            },

            // --- CHECKOUT LOGIC (Streamlined for persistence) ---
            async processCheckout() {
                if (this.state.cart.length === 0) return;

                let finalSaleTotal = 0;
                const itemsForSaleRecord = this.state.cart.map(item => {
                    const product = safeProduct(this.getProductById(item.productId));
                    if (!product) return null;

                    let effectivePricePerPiece = 0;
                    let pricePerUnitDisplayedOnReceipt = 0;

                    if (item.unit === 'piece') {
                        effectivePricePerPiece = product.prices[item.priceTier] || product.prices.retail;
                        pricePerUnitDisplayedOnReceipt = effectivePricePerPiece;
                    } else if (item.unit === 'carton') {
                        pricePerUnitDisplayedOnReceipt = product.prices.carton || product.prices.retail;
                        effectivePricePerPiece = (product.prices.carton / product.cartonSize) || product.prices.retail;
                    }

                    const quantityInPieces = item.unit === 'carton' ? item.quantity * product.cartonSize : item.quantity;
                    const itemTotal = effectivePricePerPiece * quantityInPieces;

                    // Update product stock locally
                    product.stock -= quantityInPieces; 

                    finalSaleTotal += itemTotal;

                    return {
                        productId: item.productId,
                        quantity: item.quantity,
                        unit: item.unit,
                        priceTier: item.priceTier,
                        pricePerPieceAtSale: effectivePricePerPiece,
                        pricePerUnitDisplayedOnReceipt: pricePerUnitDisplayedOnReceipt,
                        quantityInPieces: quantityInPieces,
                        itemTotal: itemTotal,
                        productName: product.name
                    };
                }).filter(item => item !== null);

                // FIX: No negative stock after checkout
                this.state.products.forEach(product => {
                    if (product.stock < 0) product.stock = 0;
                });

                const saleRecord = {
                    id: `sale_${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    items: itemsForSaleRecord,
                    total: finalSaleTotal,
                    currency: this.state.settings.currency,
                    shopName: this.state.settings.shopName,
                };
                
                this.showNotification("Processing checkout...", false);

                // 1. Record sale to Google Sheet
                await this.recordSaleToSheet(saleRecord.items); 
                
                // 2. Update product stock on the sheet
                await this.updateProductStocksOnSheet(itemsForSaleRecord);

                // 3. Clear cart locally and save local state
                this.state.cart = []; 
                this.saveState(); 

                // 4. Re-load all data (products & sales) from sheet and re-render UI
                await this.loadState(); 
                this.renderAll(); 

                // 5. Generate receipt 
                this.generateReceipt && this.generateReceipt(saleRecord);
                
                // Show final notification
                if (saleRecord.items.length > 0) {
                    const firstSoldItem = saleRecord.items[0];
                    const product = safeProduct(this.getProductById(firstSoldItem.productId));
                    if (product) this.showNotification(`${firstSoldItem.quantity} × ${product.name} sold. Checkout complete!`);
                } else {
                    this.showNotification("Checkout processed.");
                }
            },

            // --- NEW: Send sale data to Google Sheet (for Sales tab) ---
            async recordSaleToSheet(salesItems) {
                if (!this.state.settings.googleSheetUrl) {
                    this.showNotification("Google Sheet URL not configured. Sale will only save locally (not persistently).", true);
                    return; 
                }

                try {
                    await fetch(this.state.settings.googleSheetUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'recordSale', salesData: salesItems })
                    });
                } catch (error) {
                    this.showNotification("Failed to record sale to Google Sheet.", true);
                }
            },

            async updateProductStocksOnSheet(itemsForSaleRecord) {
                if (!this.state.settings.googleSheetUrl) return;
                try {
                    await fetch(this.state.settings.googleSheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'updateStocks', stockData: itemsForSaleRecord.map(item => ({
                            productId: item.productId,
                            newStock: safeProduct(this.getProductById(item.productId)).stock
                        })) })
                    });
                } catch (error) {
                    this.showNotification("Failed to update product stocks on Google Sheet.", true);
                }
            },

            showNotification(msg, isError = false) {
                const bar = this.elements.notificationBar;
                bar.textContent = msg;
                bar.classList.add('show');
                if (isError) bar.style.backgroundColor = 'rgba(220,53,69,0.9)';
                else bar.style.backgroundColor = '';
                setTimeout(() => {
                    bar.classList.remove('show');
                }, 3500);
            },

            closeModal() {
                this.elements.modalOverlay.classList.remove('visible');
                this.elements.modalBody.innerHTML = '';
            },

            showSettings() {
                // ... Your settings modal logic ...
                this.elements.modalOverlay.classList.add('visible');
                this.elements.modalBody.innerHTML = '<div>Settings UI coming soon...</div>';
            },

            showSalesLog() {
                // ... Your sales log modal logic ...
                this.elements.modalOverlay.classList.add('visible');
                this.elements.modalBody.innerHTML = '<div>Sales Log UI coming soon...</div>';
            }

            // ... Other app methods as needed ...
        };

        app.init();
        // Attach app globally for escape handler
        window.app = app;

    });
    </script>
</body>
</html>
